// Warrant - Integrity-Enforced Journalism Platform
// Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// USERS & IDENTITY
// ============================================================

enum UserRole {
  READER
  JOURNALIST
  ADMIN
}

enum VerificationStatus {
  NONE
  PENDING
  VERIFIED
  FAILED
  REVOKED
}

model User {
  id             String             @id @default(uuid())
  email          String             @unique
  displayName    String?
  role           UserRole           @default(READER)
  emailVerified  Boolean            @default(false)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relations
  sessions          Session[]
  magicLinks        MagicLink[]
  journalistProfile JournalistProfile?
  articles          Article[]
  flags             Flag[]            @relation("FlagReporter")
  flagsReviewed     Flag[]            @relation("FlagReviewer")
  corrections       Correction[]
  disputes          Dispute[]         @relation("DisputeSubmitter")
  disputesReviewed  Dispute[]         @relation("DisputeReviewer")
  appeals           Appeal[]
  appealsReviewed   Appeal[]          @relation("AppealReviewer")
  subscription      Subscription?
  reputationEvents  ReputationEvent[]
  bookmarks         Bookmark[]
  featureRequests   FeatureRequest[]
  votes             Vote[]
  integrityLabels   IntegrityLabel[]  @relation("LabelAppliedBy")
  accountActions    AccountAction[]   @relation("ActionTarget")
  accountActionsBy  AccountAction[]   @relation("ActionAppliedBy")
  notifications     Notification[]

  @@index([email])
  @@index([role])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model MagicLink {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
}

model JournalistProfile {
  id                 String             @id @default(uuid())
  userId             String             @unique
  pseudonym          String             @unique
  bio                String?
  beats              String[]           @default([])
  avatarUrl          String?
  verificationStatus VerificationStatus @default(NONE)
  stripeVerificationId String?
  stripeConnectId    String?
  reputationScore    Float              @default(50.0)
  articleCount       Int                @default(0)
  totalEarnings      Float              @default(0)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  revenueEntries  RevenueEntry[]

  @@index([pseudonym])
  @@index([verificationStatus])
  @@index([reputationScore])
}

// ============================================================
// CONTENT
// ============================================================

enum ArticleStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  PUBLISHED
  HELD
  REMOVED
}

model Article {
  id            String        @id @default(uuid())
  authorId      String
  title         String
  slug          String        @unique
  summary       String?
  content       Json
  contentText   String        // Plain text for search indexing
  status        ArticleStatus @default(DRAFT)
  version       Int           @default(1)
  publishedAt      DateTime?
  lastCorrectedAt  DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Integrity metadata
  sourceComplete  Boolean @default(false)
  claimCount      Int     @default(0)

  // Relations
  author          User              @relation(fields: [authorId], references: [id])
  versions        ArticleVersion[]
  sources         Source[]
  integrityLabels IntegrityLabel[]
  flags           Flag[]
  corrections     Correction[]
  disputes        Dispute[]
  bookmarks       Bookmark[]
  revenueEntries  RevenueEntry[]

  @@index([authorId])
  @@index([status])
  @@index([publishedAt])
  @@index([slug])
}

model ArticleVersion {
  id        String   @id @default(uuid())
  articleId String
  version   Int
  title     String
  content   Json
  summary   String?
  changedBy String
  changeNote String?
  createdAt DateTime @default(now())

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, version])
  @@index([articleId])
}

enum SourceType {
  PRIMARY_DOCUMENT
  OFFICIAL_STATEMENT
  INTERVIEW
  PUBLIC_RECORD
  SECONDARY_REPORT
  DATASET
  MULTIMEDIA
  OTHER
}

enum SourceQuality {
  PRIMARY
  SECONDARY
  ANONYMOUS
  UNVERIFIABLE
}

model Source {
  id          String        @id @default(uuid())
  articleId   String
  sourceType  SourceType
  quality     SourceQuality @default(SECONDARY)
  url         String?
  title       String
  description String?
  isAnonymous Boolean       @default(false)
  createdAt   DateTime      @default(now())

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
}

// ============================================================
// INTEGRITY SYSTEM
// ============================================================

enum LabelType {
  SUPPORTED
  DISPUTED
  NEEDS_SOURCE
  CORRECTION_ISSUED
  UNDER_REVIEW
}

model IntegrityLabel {
  id        String    @id @default(uuid())
  articleId String
  labelType LabelType
  reason    String?
  appliedBy String
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  removedAt DateTime?

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  applier User    @relation("LabelAppliedBy", fields: [appliedBy], references: [id])

  @@index([articleId])
  @@index([labelType])
}

enum FlagReason {
  INACCURATE
  MISSING_SOURCE
  MISLEADING
  DEFAMATORY
  POLICY_VIOLATION
  OTHER
}

enum FlagStatus {
  PENDING
  UNDER_REVIEW
  UPHELD
  DISMISSED
}

model Flag {
  id         String     @id @default(uuid())
  articleId  String
  reporterId String
  reason     FlagReason
  details    String?
  status     FlagStatus @default(PENDING)
  reviewedBy String?
  reviewNote String?
  createdAt  DateTime   @default(now())
  reviewedAt DateTime?

  article  Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  reporter User    @relation("FlagReporter", fields: [reporterId], references: [id])
  reviewer User?   @relation("FlagReviewer", fields: [reviewedBy], references: [id])

  @@index([articleId])
  @@index([status])
  @@index([reporterId])
}

enum CorrectionSeverity {
  TYPO
  CLARIFICATION
  FACTUAL_ERROR
  MATERIAL_ERROR
  RETRACTION
}

enum CorrectionStatus {
  PENDING
  PUBLISHED
  REJECTED
}

model Correction {
  id        String             @id @default(uuid())
  articleId String
  authorId  String
  content   String
  severity  CorrectionSeverity
  status    CorrectionStatus   @default(PENDING)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [authorId], references: [id])

  @@index([articleId])
  @@index([status])
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  UPHELD
  OVERTURNED
  DISMISSED
}

model Dispute {
  id          String        @id @default(uuid())
  articleId   String
  submitterId String
  reason      String
  evidence    String?
  status      DisputeStatus @default(OPEN)
  reviewedBy  String?
  resolution  String?
  createdAt   DateTime      @default(now())
  resolvedAt  DateTime?

  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  submitter User     @relation("DisputeSubmitter", fields: [submitterId], references: [id])
  reviewer  User?    @relation("DisputeReviewer", fields: [reviewedBy], references: [id])
  appeal    Appeal?

  @@index([articleId])
  @@index([status])
}

enum AppealStatus {
  PENDING
  UNDER_REVIEW
  UPHELD
  DENIED
}

model Appeal {
  id         String       @id @default(uuid())
  disputeId  String       @unique
  userId     String
  reason     String
  evidence   String?
  status     AppealStatus @default(PENDING)
  reviewedBy String?
  decision   String?
  createdAt  DateTime     @default(now())
  decidedAt  DateTime?

  dispute  Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  user     User    @relation(fields: [userId], references: [id])
  reviewer User?   @relation("AppealReviewer", fields: [reviewedBy], references: [id])

  @@index([status])
}

// ============================================================
// REPUTATION
// ============================================================

enum ReputationEventType {
  ARTICLE_PUBLISHED
  ARTICLE_CITED
  SOURCE_COMPLETE
  CORRECTION_ISSUED_MINOR
  CORRECTION_ISSUED_MAJOR
  DISPUTE_UPHELD_AGAINST
  DISPUTE_OVERTURNED_FOR
  FLAG_UPHELD_AGAINST
  TENURE_BONUS
  MANUAL_ADJUSTMENT
}

model ReputationEvent {
  id        String              @id @default(uuid())
  userId    String
  type      ReputationEventType
  delta     Float
  reason    String?
  articleId String?
  createdAt DateTime            @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// ============================================================
// ACCOUNT ACTIONS
// ============================================================

enum AccountActionType {
  THROTTLED
  REVENUE_SUSPENDED
  COOLDOWN
  BANNED
  RESTORED
}

model AccountAction {
  id        String            @id @default(uuid())
  userId    String
  type      AccountActionType
  reason    String
  appliedBy String
  expiresAt DateTime?
  active    Boolean           @default(true)
  createdAt DateTime          @default(now())

  user    User @relation("ActionTarget", fields: [userId], references: [id])
  applier User @relation("ActionAppliedBy", fields: [appliedBy], references: [id])

  @@index([userId])
  @@index([active])
}

// ============================================================
// PAYMENTS & REVENUE
// ============================================================

enum SubscriptionPlan {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique
  stripeSubscriptionId String?            @unique
  stripeCustomerId     String?
  plan                 SubscriptionPlan
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeSubscriptionId])
  @@index([status])
}

enum RevenueEntryStatus {
  PENDING
  CALCULATED
  PAID
  FAILED
}

model RevenueEntry {
  id           String             @id @default(uuid())
  journalistId String
  articleId    String?
  period       String             // YYYY-MM
  amount       Float
  reads        Int                @default(0)
  integrityMultiplier Float      @default(1.0)
  status       RevenueEntryStatus @default(PENDING)
  paidAt       DateTime?
  createdAt    DateTime           @default(now())

  journalist JournalistProfile @relation(fields: [journalistId], references: [id])
  article    Article?          @relation(fields: [articleId], references: [id])

  @@index([journalistId])
  @@index([period])
  @@index([status])
}

model PlatformConfig {
  id             String @id @default("default")
  platformMargin Float  @default(0.15)  // 15%
  monthlyPrice   Int    @default(500)   // $5.00 in cents
  annualPrice    Int    @default(5000)  // $50.00 in cents
  updatedAt      DateTime @updatedAt
}

// ============================================================
// ENGAGEMENT & FEATURES
// ============================================================

model Bookmark {
  id        String   @id @default(uuid())
  userId    String
  articleId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
}

enum FeatureRequestStatus {
  OPEN
  PLANNED
  NOT_PLANNED
  IN_PROGRESS
  SHIPPED
}

model FeatureRequest {
  id          String               @id @default(uuid())
  userId      String
  title       String
  description String
  status      FeatureRequestStatus @default(OPEN)
  decisionLog String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  user  User   @relation(fields: [userId], references: [id])
  votes Vote[]

  @@index([status])
}

model Vote {
  id               String   @id @default(uuid())
  userId           String
  featureRequestId String
  createdAt        DateTime @default(now())

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  featureRequest FeatureRequest @relation(fields: [featureRequestId], references: [id], onDelete: Cascade)

  @@unique([userId, featureRequestId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

// ============================================================
// AUDIT LOG
// ============================================================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}
